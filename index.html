<html>
  
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--link rel="manifest" href="/manifest.json"-->
    <link rel="stylesheet" href="/vendor/onsen/onsenui.css">
    <link rel="stylesheet" href="/vendor/onsen/onsen-css-components.min.css">
    <script src="/vendor/onsen/onsenui.min.js"></script>
    <script src="/vendor/Chart.min.js"></script>
    <script src="/js/core/bundle.js"></script>
  </head>

  <body>
    <ons-page>
      <canvas id="chart--pie__day" width="400" height="400"></canvas>
      <canvas id="chart--line__week" width="300" height="300"></canvas>
    </ons-page>


    <script>
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function () {
            navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function (registration) {
              console.log('SW registered: ', registration)
            }).catch(function (registrationError) {
              console.log('SW registration failed: ', registrationError)
            })
          })
        }
    </script>

    <script>
      function randomScalingFactor(){
        return 100
      }

      //Create today pie chart
      const ctx = document.getElementById('chart--pie__day');
      core.db.readAllCostToday().then(costs => {
        return {
          datasets: [{
            data: costs.map(it => it.cost)
          }],
          labels: costs.map(it => it.type)
        }
      }).then(data => {
        new Chart(ctx, {
          type: 'doughnut',
          data,
        });
      })

      //Create Weekly Barchart
      const ctx2 = document.getElementById('chart--line__week');
      core.getWeeklyAnalysis(new Date()).then(dateCostMaps => {
        const config = {
    			type: 'line',
    			data: {
            labels: Object.keys(dateCostMaps),
            datasets: [{
              label: '本周支出',
              data: Object.keys(dateCostMaps).map(key => {
                return dateCostMaps[key]
              })
            }],
    			},
        }
        console.log(config.data)
        return config
      }).then((config) => {
        new Chart(ctx2, config);
      })
    </script>
  </body>

</html>